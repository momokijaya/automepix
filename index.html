<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default theme set to dark -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indexinode Professional - AI Metadata Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-color: #06b6d4; /* Cyan */
            --primary-hover: #0891b2;
            --secondary-color: #4f46e5; /* Indigo */
            --danger-color: #e11d48; /* Rose */
            --success-color: #22c55e; /* Green */
            --warning-color: #f59e0b; /* Amber */

            /* Dark Theme */
            --bg-dark: #0f172a; /* Slate 900 */
            --surface-dark: #1e293b; /* Slate 800 */
            --border-dark: #334155; /* Slate 700 */
            --text-main-dark: #cbd5e1; /* Slate 300 */
            --text-heading-dark: #f1f5f9; /* Slate 100 */

            /* Light Theme */
            --bg-light: #f1f5f9; /* Slate 100 */
            --surface-light: #ffffff;
            --border-light: #e2e8f0; /* Slate 200 */
            --text-main-light: #475569; /* Slate 600 */
            --text-heading-light: #0f172a; /* Slate 900 */

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) transparent;
        }

        *::-webkit-scrollbar { width: 8px; height: 8px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; border: 2px solid transparent; background-clip: content-box; }
        *::-webkit-scrollbar-thumb:hover { background: var(--primary-hover); }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-main-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark body {
            background-color: var(--bg-dark);
            color: var(--text-main-dark);
        }
        
        .surface {
             background-color: var(--surface-light);
             border: 1px solid var(--border-light);
             box-shadow: var(--shadow-lg);
        }
        
        .dark .surface {
            background-color: color-mix(in srgb, var(--surface-dark) 85%, transparent);
            border: 1px solid var(--border-dark);
        }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 0.5rem;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }

        .btn-process { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; }
        .btn-process:hover { background-size: 150% 150%; }

        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: #be123c; }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-light);
            color: var(--text-heading-light);
        }
        .dark .btn-secondary {
             background-color: transparent;
             border: 1px solid var(--border-dark);
             color: var(--text-heading-dark);
        }
        .btn-secondary:hover:not(.active) {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .view-btn.active {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-lg);
        }


        /* --- Typography --- */
        .title-text {
            background: linear-gradient(45deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-family: 'Poppins', sans-serif;
            font-weight: 800;
        }
        .dark .title-text {
             background: linear-gradient(45deg, #22d3ee 0%, #a5b4fc 100%);
             -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        /* --- Cards --- */
        .image-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
        }
        .image-card:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1); }
        .image-card.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }
        .image-card .processing-overlay {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .image-card.processing .processing-overlay {
            opacity: 1;
        }


        /* --- Inputs --- */
        .custom-input {
            background-color: var(--bg-light);
            border: 1px solid var(--border-light);
            color: var(--text-heading-light);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .dark .custom-input {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-dark);
            color: var(--text-heading-dark);
        }
        .custom-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 20%, transparent);
        }
        
        /* --- Modals --- */
        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: color-mix(in srgb, var(--bg-dark) 60%, transparent);
        }
        .dark .modal-backdrop { background: color-mix(in srgb, var(--bg-dark) 80%, transparent); }

        /* --- Other Elements --- */
        .section-header {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--text-heading-light);
            position: relative;
            padding-bottom: 0.5rem;
        }
        .dark .section-header { color: var(--text-heading-dark); }
        .section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 40px;
            height: 3px;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
        }

        .status-unprocessed { background-color: #64748b; color: white; } /* Slate */
        .status-processing { background-color: var(--warning-color); color: white; animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .status-ready { background-color: var(--success-color); color: white; }
        .status-error { background-color: var(--danger-color); color: white; }

        /* --- Gallery View Styles --- */
        #image-gallery.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        #image-gallery.grid-view .image-card {
            flex-direction: column;
        }
        #image-gallery.grid-view .image-card .flex-shrink-0 {
            width: 100%;
        }
        #image-gallery.grid-view .image-card .thumbnail {
            height: 12rem; /* 192px */
        }
        #image-gallery.list-view {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* --- Animations --- */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        @keyframes pulse { 50% { opacity: .5; } }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Main Application -->
    <div id="app" class="min-h-screen">
        <div class="max-w-8xl mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Main Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Sidebar -->
                <aside class="lg:col-span-1 space-y-6">
                    <div class="surface rounded-3xl p-5 fade-in space-y-6 sticky top-6">
                        <div class="text-center">
                            <div class="flex items-center justify-center space-x-3 mb-2">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center shadow-lg bg-gradient-to-br from-cyan-400 to-indigo-600">
                                    <i class="fas fa-robot text-white text-xl"></i>
                                </div>
                                <h1 class="text-xl font-bold title-text">Indexinode</h1>
                            </div>
                            <p class="text-xs text-slate-400">Developed by Apinakew</p>
                        </div>

                        <div>
                            <h2 class="section-header text-xl mb-4" data-lang="quick_actions">üöÄ Actions</h2>
                            <div class="space-y-3">
                                <button id="add-files-btn" class="w-full btn btn-primary"><i class="fas fa-file-plus mr-2"></i><span data-lang="add_files">Add Files</span></button>
                                <button id="add-folder-btn" class="w-full btn btn-secondary"><i class="fas fa-folder-plus mr-2"></i><span data-lang="add_folder">Add Folder</span></button>
                                <button id="batch-all-btn" class="w-full btn btn-process"><i class="fas fa-magic-wand-sparkles mr-2"></i><span data-lang="batch_all_files">Process All</span></button>
                                <button id="stop-batch-btn" class="w-full btn btn-danger hidden"><i class="fas fa-stop-circle mr-2"></i><span>Stop</span></button>
                                <button id="export-csv-btn" class="w-full btn btn-secondary"><i class="fas fa-file-export mr-2"></i><span data-lang="export_metadata_csv">Export CSV</span></button>
                                <button id="keyword-tools-btn" class="w-full btn btn-secondary"><i class="fas fa-tools mr-2"></i><span>Keyword Tools</span></button>
                                <button id="settings-btn" class="w-full btn btn-secondary"><i class="fas fa-cog mr-2"></i><span data-lang="options">Settings</span></button>
                            </div>
                        </div>

                        <div>
                            <h2 class="section-header text-xl mb-4" data-lang="stats_group">üìä Statistics</h2>
                            <div class="grid grid-cols-2 gap-3 text-center">
                                <div class="bg-slate-100 dark:bg-slate-700/50 rounded-2xl p-3">
                                    <div class="text-xs font-medium uppercase text-slate-500 mb-1" data-lang="total_files">Total</div>
                                    <div id="stats-total" class="text-2xl font-bold text-slate-800 dark:text-slate-100">0</div>
                                </div>
                                <div class="bg-green-500/10 dark:bg-green-500/20 rounded-2xl p-3">
                                    <div class="text-xs font-medium uppercase text-green-600 dark:text-green-400 mb-1" data-lang="processed_files">Done</div>
                                    <div id="stats-processed" class="text-2xl font-bold text-green-500">0</div>
                                </div>
                                <div class="bg-amber-500/10 dark:bg-amber-500/20 rounded-2xl p-3">
                                    <div class="text-xs font-medium uppercase text-amber-600 dark:text-amber-400 mb-1" data-lang="pending_files">Pending</div>
                                    <div id="stats-pending" class="text-2xl font-bold text-amber-500">0</div>
                                </div>
                                <div class="bg-rose-500/10 dark:bg-rose-500/20 rounded-2xl p-3">
                                    <div class="text-xs font-medium uppercase text-rose-600 dark:text-rose-400 mb-1" data-lang="error_files">Errors</div>
                                    <div id="stats-errors" class="text-2xl font-bold text-rose-500">0</div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <div class="flex items-center space-x-2">
                                <button id="theme-toggle" class="w-full btn btn-secondary text-sm">
                                    <i class="fas fa-sun text-slate-700 dark:text-slate-300 text-sm"></i>
                                </button>
                                <select id="language-select" class="w-full custom-input text-sm">
                                    <option value="English">English</option>
                                    <option value="Indonesia">Indonesia</option>
                                </select>
                            </div>
                            <button id="clear-all-btn" class="w-full btn btn-danger"><i class="fas fa-trash-alt mr-2"></i><span data-lang="clear_all">Clear All</span></button>
                        </div>
                    </div>
                </aside>

                <!-- Main Gallery Area -->
                <main class="lg:col-span-4 h-[calc(100vh-3rem)]">
                    <div class="surface rounded-3xl p-6 h-full flex flex-col fade-in">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                             <div class="flex items-center gap-2">
                                <label for="filter-select" class="text-sm font-medium whitespace-nowrap">Filter by:</label>
                                <select id="filter-select" class="custom-input text-sm py-1.5">
                                    <option value="all">Show All</option>
                                    <option value="ready">Processed</option>
                                    <option value="unprocessed">Pending</option>
                                    <option value="error">Error</option>
                                </select>
                             </div>
                             <div id="bulk-edit-panel" class="hidden flex-1 min-w-[200px]">
                                <button id="bulk-edit-btn" class="w-full btn btn-secondary btn-sm"><i class="fas fa-edit mr-2"></i>Bulk Edit Selected</button>
                             </div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <label for="sort-select" class="text-sm font-medium whitespace-nowrap">Sort by:</label>
                                    <select id="sort-select" class="custom-input text-sm py-1.5">
                                        <option value="date_desc">Newest</option>
                                        <option value="date_asc">Oldest</option>
                                        <option value="name_asc">Name (A-Z)</option>
                                        <option value="name_desc">Name (Z-A)</option>
                                    </select>
                                </div>
                                 <div class="flex items-center border border-slate-200 dark:border-slate-700 rounded-lg">
                                    <button id="list-view-btn" class="view-btn btn-secondary p-2 rounded-l-md active"><i class="fas fa-list"></i></button>
                                    <button id="grid-view-btn" class="view-btn btn-secondary p-2 rounded-r-md"><i class="fas fa-th-large"></i></button>
                                </div>
                            </div>
                        </div>


                        <div id="gallery-container" class="flex-1 rounded-2xl bg-slate-100 dark:bg-slate-900/70 p-4 overflow-y-auto">
                            <div id="gallery-placeholder" class="h-full flex flex-col items-center justify-center text-center text-slate-500 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-8">
                                <div class="w-24 h-24 rounded-full bg-slate-200 dark:bg-slate-800 mb-6 flex items-center justify-center">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-slate-400"></i>
                                </div>
                                <p class="font-bold text-xl mb-2" data-lang="drag_drop_placeholder">Drop your images here</p>
                                <p class="text-sm text-slate-500" data-lang="add_files_prompt">Or use the buttons to add files</p>
                            </div>
                            <div id="image-gallery" class="list-view">
                                <!-- Image cards will be inserted here -->
                            </div>
                        </div>

                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-sm font-semibold" data-lang="progress">Progress</span>
                                <span id="progress-label" class="text-sm text-slate-500 font-medium" data-lang="ready">Ready</span>
                            </div>
                            <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-3 overflow-hidden">
                                <div id="progress-bar" class="h-full rounded-full transition-all duration-500 ease-out" style="width: 0%; background-color: var(--primary-color);"></div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="file-input" multiple accept="image/jpeg, image/png" class="hidden">
    <input type="file" id="folder-input" webkitdirectory directory class="hidden">

    <!-- Modals -->
    <div id="settings-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="surface rounded-3xl w-full max-w-lg p-8 fade-in flex flex-col">
            <div class="flex justify-between items-center border-b border-slate-200 dark:border-slate-700 pb-6">
                <h3 class="text-2xl font-bold title-text" data-lang="options">Settings</h3>
                <button id="close-settings-btn" class="w-10 h-10 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center justify-center"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="mt-8 grid grid-cols-1 gap-6 flex-grow overflow-y-auto pr-2">
                 <div>
                    <h4 class="text-lg font-semibold mb-4 text-slate-800 dark:text-slate-200">Configuration</h4>
                    <div class="space-y-6">
                        <div>
                            <label for="model-select" class="block text-sm font-semibold mb-2">AI Model</label>
                            <select id="model-select" class="w-full custom-input">
                                <option>gemini-2.0-flash</option>
                                <option>gemini-2.0-pro</option>
                                <option>gemini-2.5-flash</option>
                                <option>gemini-2.5-pro</option>
                            </select>
                        </div>
                        <div>
                           <label for="prompt-style-select-modal" class="block text-sm font-semibold mb-2" data-lang="prompt_style">Prompt Style</label>
                           <select id="prompt-style-select-modal" class="w-full custom-input">
                               <option value="microstock">üì∏ Microstock</option>
                               <option value="professional">üíº Professional</option>
                               <option value="creative">üé® Creative</option>
                               <option value="fotografer">üì∑ Photographer</option>
                           </select>
                        </div>
                        <div>
                            <label for="delay-input" class="block text-sm font-semibold mb-2">Batch Delay (seconds)</label>
                            <input type="number" id="delay-input" min="0" max="60" class="w-full custom-input" value="5">
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4 text-slate-800 dark:text-slate-200">Presets</h4>
                    <div class="flex gap-2">
                        <input type="text" id="preset-name-input" placeholder="New Preset Name..." class="w-full custom-input">
                        <button id="save-preset-btn" class="btn btn-secondary">Save</button>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <select id="preset-select" class="w-full custom-input">
                            <option>Load a preset...</option>
                        </select>
                        <button id="delete-preset-btn" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="save-settings-btn" class="btn btn-primary">Save Settings</button>
            </div>
        </div>
    </div>
    
    <div id="translate-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
         <div class="surface rounded-3xl w-full max-w-sm p-8 fade-in">
            <h3 class="text-2xl font-bold mb-6 title-text" data-lang="translate_to">Translate to...</h3>
            <div id="translate-language-list" class="grid grid-cols-1 gap-3"></div>
            <div class="mt-8 text-right">
                <button id="close-translate-btn" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

     <div id="clean-keywords-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="surface rounded-3xl w-full max-w-sm p-8 fade-in">
            <h3 class="text-2xl font-bold mb-6 title-text" data-lang="clean_keywords">Keyword Options</h3>
            <div class="space-y-4">
                <label class="flex items-center space-x-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition cursor-pointer">
                    <input type="checkbox" id="clean-duplicates" class="rounded-lg text-cyan-600 focus:ring-cyan-500 w-5 h-5 border-slate-400" checked>
                    <span class="font-medium">Remove Duplicates</span>
                </label>
                <label class="flex items-center space-x-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition cursor-pointer">
                    <input type="checkbox" id="clean-lowercase" class="rounded-lg text-cyan-600 focus:ring-cyan-500 w-5 h-5 border-slate-400" checked>
                    <span class="font-medium">Convert to Lowercase</span>
                </label>
                <label class="flex items-center space-x-3 p-3 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700/50 transition cursor-pointer">
                    <input type="checkbox" id="clean-whitespace" class="rounded-lg text-cyan-600 focus:ring-cyan-500 w-5 h-5 border-slate-400" checked>
                    <span class="font-medium">Trim Whitespace</span>
                </label>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button id="cancel-clean-btn" class="btn btn-secondary">Cancel</button>
                <button id="apply-clean-btn" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>

    <div id="keyword-tools-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="surface rounded-3xl w-full max-w-lg p-8 fade-in">
             <div class="flex justify-between items-center border-b border-slate-200 dark:border-slate-700 pb-6">
                <h3 class="text-2xl font-bold title-text">Keyword Tools</h3>
                <button id="close-keyword-tools-btn" class="w-10 h-10 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center justify-center"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="mt-8 space-y-6">
                 <div>
                    <label for="always-include-keywords" class="block text-sm font-semibold mb-2">Always Include Keywords</label>
                    <textarea id="always-include-keywords" rows="3" class="w-full custom-input" placeholder="e.g. nature, landscape, mybrand"></textarea>
                    <p class="text-xs text-slate-500 mt-1">Comma-separated keywords to always add to results.</p>
                </div>
                 <div>
                    <label for="blacklist-keywords" class="block text-sm font-semibold mb-2">Blacklisted Keywords</label>
                    <textarea id="blacklist-keywords" rows="3" class="w-full custom-input" placeholder="e.g. person, people, logo"></textarea>
                     <p class="text-xs text-slate-500 mt-1">Comma-separated keywords to remove from results.</p>
                </div>
            </div>
             <div class="mt-8 flex justify-end">
                <button id="save-keyword-tools-btn" class="btn btn-primary">Save Keyword Rules</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center hidden z-50">
        <div class="surface rounded-3xl w-full max-w-sm p-8 fade-in text-center">
             <div class="w-16 h-16 mx-auto rounded-full bg-amber-100 dark:bg-amber-500/20 flex items-center justify-center mb-6">
                 <i class="fas fa-exclamation-triangle text-3xl text-amber-500"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold mb-2 text-slate-800 dark:text-slate-100">Are you sure?</h3>
            <p id="confirm-message" class="text-slate-500 mb-8">You won't be able to revert this!</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-ok-btn" class="btn btn-danger">Yes, do it!</button>
            </div>
        </div>
    </div>


    <!-- Image Card Template -->
    <template id="image-card-template">
        <div class="image-card surface rounded-2xl p-4 flex flex-col lg:flex-row gap-6 relative group">
            <div class="selection-indicator absolute top-3 left-3 w-6 h-6 rounded-full bg-white/50 dark:bg-slate-900/50 border-2 border-white dark:border-slate-600 flex items-center justify-center opacity-0 group-[.selected]:opacity-100 transition-opacity z-20">
                 <i class="fas fa-check text-xs text-white"></i>
            </div>
            <button class="delete-btn absolute top-3 right-3 w-8 h-8 rounded-full bg-rose-500 text-white transition flex items-center justify-center opacity-0 group-hover:opacity-100 z-10">
                <i class="fas fa-times text-sm"></i>
            </button>
            <div class="flex-shrink-0 w-full lg:w-52 text-center relative">
                <div class="processing-overlay absolute inset-0 bg-slate-900/50 rounded-xl flex items-center justify-center z-10">
                    <i class="fas fa-spinner spinner text-white text-3xl"></i>
                </div>
                <img class="thumbnail w-full h-52 object-cover rounded-xl mb-3 shadow-md">
                <span class="status-label text-xs font-bold uppercase tracking-wider py-1.5 px-3 rounded-full shadow-sm">Unprocessed</span>
            </div>
            <div class="flex-grow flex flex-col space-y-3">
                <div class="border-b border-slate-200 dark:border-slate-700 pb-2">
                    <p class="filename font-mono text-sm text-slate-500 truncate pr-10 font-semibold"></p>
                    <p class="file-size text-xs text-slate-400 font-medium mt-1"></p>
                </div>
                <div class="relative">
                    <label class="block text-sm font-bold mb-1.5 text-slate-800 dark:text-slate-200" data-lang="title">‚ú® Title</label>
                    <input type="text" class="title-input w-full custom-input text-sm pr-10" data-lang-placeholder="title_placeholder">
                    <button class="copy-btn absolute top-8 right-2 text-slate-400 hover:text-cyan-500 p-1"><i class="fas fa-copy"></i></button>
                </div>
                <div class="relative">
                    <label class="block text-sm font-bold mb-1.5 text-slate-800 dark:text-slate-200" data-lang="description">üìù Description</label>
                    <textarea rows="2" class="description-input w-full custom-input text-sm resize-none pr-10" data-lang-placeholder="description_placeholder"></textarea>
                    <button class="copy-btn absolute top-8 right-2 text-slate-400 hover:text-cyan-500 p-1"><i class="fas fa-copy"></i></button>
                </div>
                <div class="relative">
                    <div class="flex justify-between items-center mb-1.5">
                        <label class="block text-sm font-bold text-slate-800 dark:text-slate-200" data-lang="keywords">üè∑Ô∏è Keywords</label>
                        <span class="keyword-count text-xs px-2 py-1 rounded-lg bg-slate-200 dark:bg-slate-700 font-semibold">0 keywords</span>
                    </div>
                    <textarea rows="3" class="keywords-input w-full custom-input text-sm resize-none pr-10" data-lang-placeholder="keywords_placeholder"></textarea>
                    <button class="copy-btn absolute top-8 right-2 text-slate-400 hover:text-cyan-500 p-1"><i class="fas fa-copy"></i></button>
                </div>
                <div class="flex flex-wrap gap-2 pt-2">
                    <div class="relative flex-1 min-w-[120px]">
                        <button class="generate-btn w-full btn btn-primary text-sm">
                            <i class="fas fa-sparkles mr-2"></i><span data-lang="generate">Generate</span>
                        </button>
                        <div class="regenerate-menu hidden absolute bottom-full mb-2 w-full surface rounded-xl shadow-xl z-10 overflow-hidden">
                            <a href="#" class="regenerate-choice block px-4 py-3 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition font-medium" data-field="title" data-lang="regenerate_title">‚ú® Re-generate Title</a>
                            <a href="#" class="regenerate-choice block px-4 py-3 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition font-medium" data-field="description" data-lang="regenerate_description">üìù Re-generate Description</a>
                            <a href="#" class="regenerate-choice block px-4 py-3 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition font-medium" data-field="keywords" data-lang="regenerate_keywords">üè∑Ô∏è Re-generate Keywords</a>
                            <div class="border-t my-1 border-slate-200 dark:border-slate-700"></div>
                            <a href="#" class="regenerate-choice block px-4 py-3 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 transition font-bold" data-field="all" data-lang="regenerate_all">üîÑ Re-generate All</a>
                        </div>
                    </div>
                    <button class="translate-btn btn btn-secondary text-sm flex-1 min-w-[120px]" disabled><i class="fas fa-language mr-2"></i><span data-lang="translate">Translate</span></button>
                    <button class="clean-keywords-btn btn btn-secondary text-sm flex-1 min-w-[120px]" disabled><i class="fas fa-broom mr-2"></i><span data-lang="clean_keywords">Clean</span></button>
                </div>
            </div>
        </div>
    </template>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-3 w-full max-w-xs"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_KEYS = [
            "AIzaSyDE-eC4Z5sLoyLb-gfufWybfq5FDfQ8eJA",
            "AIzaSyCJCLcOLSxNzAo7Yj2OkFrvBCmriMWWY4A",
            "AIzaSyBCN3QCP0JAlh8T0A4I_bnYO8dRJaxgllc",
            "AIzaSyB7ZflQgfuCdAwCdJqy5ls1mGoVQCK0Ghg",
            "AIzaSyBk5rAPyic400shgKO1PAAPJYbnoYj7IqA",
            "AIzaSyCEgpllq7leaQTBVE-f75plyvxVGR5W_ao",
            "AIzaSyALljReS1FmyIo97G8jTSrsxzg_Cso17Cg",
            "AIzaSyD5Pnxdj4ZOAr3xAd6BiaO4IG8SG0nWGp4",
            "AIzaSyDKnnXW9NA7uyMMAVG9uYUvJ4hxqcDi6_o",
            "AIzaSyChFUV-BPSFJ7poTCVR0Cxy9L8ds4Ldiww",
            "AIzaSyBiJPu2xcdgwLid7qmTE4jo4kz3Z0KdVwo",
            "AIzaSyBm7ybTjettHpMpOXC44RFuugTvSL9AfyM",
            "AIzaSyDkFafHvNqvVtpKhNkXVe1OauD2-fToTzI",
            "AIzaSyAy67NvK3oXQlYeuHsxeZKZGZyhpS4sUIY",
            "AIzaSyDqAcC5A-BCl9Jx_Phf00TSChtQsbXEdrk",
            "AIzaSyBx-6s73J21nC26BUpANly7JumBdoI9xIQ",
            "AIzaSyBVKX4N-G5N_A6HJBkPYPJtuNUu71QJH00",
            "AIzaSyD8Wp9dObil7_0s0H245qWI7WAboQkjdN0",
            "AIzaSyCfJqiEAATvUm0W8ObytHcVVnbfzYxtjgI",
            "AIzaSyCvPrjP0JDJI5MG6fOUp4aNhcp4I_ECZRc",
            "AIzaSyBvr68vnrqULhtNVZL1qAbuO5plpKH3FAk",
            "AIzaSyDb4-TEf5XpEgccDzT-ljW1-3WMAKIueI4",
            "AIzaSyDn2GIW4umXSQlHqr93zr4SY_EiQ_wdPfA",
            "AIzaSyCm6enRK31KfDv14xEy_DJlSBnqq0Azh_E",
            "AIzaSyDIhc8O1ZUgiNACedX042xcAm923lJlpQQ",
            "AIzaSyC39ZdFoP_dL2lMCxd4toHKSiCNa6TjwLg",
            "AIzaSyDH8KTnWkaC16PQzI4MCy6zN7WkDpBEKDA",
            "AIzaSyB3dWuBMb0qteIP4L6Nb6KCyBZRcKIVem8",
            "AIzaSyBB5gMx6G0R02L5a2ebYlIYOwn7paZyiTM",
            "AIzaSyC5a5nVr2Xl3g27CzEkM4cxDcRj18QEikw",
            "AIzaSyB9rj_61pBwo-i3o75cAlqTbNkJg55_mH4",
            "AIzaSyDdhxFL_c-ng0nE2gohhnQYNZo6pDC68hc",
            "AIzaSyAB3Xciz90acmlT2aaJKILGEv855ol6OAA",
            "AIzaSyCbjoknzlVgBhAllzP0bI4mLxIgJReKg6s",
            "AIzaSyDxedzgoLaeH6HrH2lIGpEdy-SCW1a9KGU",
            "AIzaSyCMhvZvu9xaCii5lLGJ4ZOwxrhp898qStE",
            "AIzaSyD7Q7oHvp2cizaCG8I2mvEN70_yBD8Y7Ew",
            "AIzaSyAASnZpn_TOkHCqzUppJ1EdLIVLiOPYsGI",
            "AIzaSyAnH3M3OO7ecyVghLFkZqH53cQM-R-pOL0",
            "AIzaSyBQZxg7_o_7EX6UCmX8dwTIDJUH6APCkXk",
            "AIzaSyA7YQoKMTjz4LAUhjGwOySArHJXp1HikVk",
            "AIzaSyBoOhUdRm8N4eHg4SZbZsPqddyBpyqfWxs",
            "AIzaSyBB5nBm3oGH9ave0Ix8l6i6S7K-p-cDooQ",
            "AIzaSyDC_xfL0rS38CVyPjjpf72HakG3r5qLrlM",
            "AIzaSyBO0jGyOHa1N926svN5k-t_l79r7Kx5jtU",
            "AIzaSyBAx8MajsvGrcCbQ4uU-H_5vOWsppqMB-A",
            "AIzaSyCOffgp57pdF0YStr6hx9ebRMsGNF-xVac",
            "AIzaSyBZ9DmnBWIhICwFS4rgfEAgVOWKQTvsDco",
            "AIzaSyAYCj1fUO_6rKT2UgHi6Y6ITtXYFP9lcEQ",
            "AIzaSyDM0YxVpninfgvtXyP0m_6WfIfAFOBmqno",
            "AIzaSyDHa1GwBT_-d40Ug5S_HGQ4fPPcsCF5HoI"
        ];
        let apiKeyIndex = 0;

        let settings = { model: 'gemini-2.0-flash', delay: 0, promptStyle: 'microstock', theme: 'dark', language: 'English' };
        let imageObjects = new Map();
        let taskQueue = [];
        let isProcessing = false;
        let selectedCards = new Set();
        let allSelected = false;
        let totalTasksInBatch = 0;
        let activeModalId = null;
        let batchStopRequested = false;
        let currentBatchController = null;
        let keywordSettings = { blacklist: [], alwaysInclude: [] };
        let presets = {};

        let currentFilter = 'all';
        let currentSort = 'date_desc';

        const MAX_KEYWORDS = 50;
        const TARGET_LANGUAGES = ["English", "Indonesian", "Spanish", "French", "German", "Japanese", "Korean"];

        const LANGUAGES = { "English": { "app_subtitle": "AI-Powered Metadata Generator", "quick_actions": "Quick Actions", "add_files": "Add Files", "add_folder": "Add Folder", "batch_all_files": "Process All", "export_metadata_csv": "Export CSV", "clear_all": "Clear All", "stats_group": "Statistics", "total_files": "Total", "processed_files": "Done", "pending_files": "Pending", "error_files": "Errors", "prompt_style": "Prompt Style", "options": "Settings", "image_gallery": "Image Gallery", "select_all": "‚úÖ Select All", "deselect_all": "‚ùå Deselect All", "progress": "Progress", "ready": "Ready", "drag_drop_placeholder": "Drop your images here", "add_files_prompt": "Or use the buttons to add files", "status_unprocessed": "Unprocessed", "status_processing": "Processing...", "status_ready": "Ready", "status_error": "Error", "title": "Title", "description": "Description", "keywords": "Keywords", "title_placeholder": "AI will generate...", "description_placeholder": "AI will generate...", "keywords_placeholder": "AI will generate...", "generate": "Generate", "regenerate": "Re-generate", "translate": "Translate", "clean_keywords": "Clean", "regenerate_title": "Re-generate Title", "regenerate_description": "Re-generate Description", "regenerate_keywords": "Re-generate Keywords", "regenerate_all": "Re-generate All", "translate_to": "Translate to..." }, "Indonesia": { "app_subtitle": "Penghasil Metadata Berbasis AI", "quick_actions": "Aksi Cepat", "add_files": "Tambah Berkas", "add_folder": "Tambah Folder", "batch_all_files": "Proses Semua", "export_metadata_csv": "Ekspor CSV", "clear_all": "Bersihkan Semua", "stats_group": "Statistik", "total_files": "Total", "processed_files": "Selesai", "pending_files": "Tertunda", "error_files": "Galat", "prompt_style": "Gaya Prompt", "options": "Pengaturan", "image_gallery": "Galeri Gambar", "select_all": "‚úÖ Pilih Semua", "deselect_all": "‚ùå Batal Pilih", "progress": "Kemajuan", "ready": "Siap", "drag_drop_placeholder": "Letakkan gambar Anda di sini", "add_files_prompt": "Atau gunakan tombol untuk menambah berkas", "status_unprocessed": "Belum Diproses", "status_processing": "Memproses...", "status_ready": "Siap", "status_error": "Galat", "title": "Judul", "description": "Deskripsi", "keywords": "Kata Kunci", "title_placeholder": "AI akan menghasilkan...", "description_placeholder": "AI akan menghasilkan...", "keywords_placeholder": "AI akan menghasilkan...", "generate": "Hasilkan", "regenerate": "Hasilkan Ulang", "translate": "Terjemahkan", "clean_keywords": "Bersihkan", "regenerate_title": "Hasilkan Ulang Judul", "regenerate_description": "Hasilkan Ulang Deskripsi", "regenerate_keywords": "Hasilkan Ulang Kata Kunci", "regenerate_all": "Hasilkan Ulang Semua", "translate_to": "Terjemahkan ke..." } };

        function _(key) { return LANGUAGES[settings.language]?.[key] || LANGUAGES['English'][key] || key; }

        const dom = {
            app: document.getElementById('app'), galleryContainer: document.getElementById('gallery-container'), galleryPlaceholder: document.getElementById('gallery-placeholder'), imageGallery: document.getElementById('image-gallery'), imageCardTemplate: document.getElementById('image-card-template'), addFilesBtn: document.getElementById('add-files-btn'), addFolderBtn: document.getElementById('add-folder-btn'), fileInput: document.getElementById('file-input'), folderInput: document.getElementById('folder-input'), clearAllBtn: document.getElementById('clear-all-btn'), batchAllBtn: document.getElementById('batch-all-btn'), stopBatchBtn: document.getElementById('stop-batch-btn'), exportCsvBtn: document.getElementById('export-csv-btn'), statsTotal: document.getElementById('stats-total'), statsProcessed: document.getElementById('stats-processed'), statsPending: document.getElementById('stats-pending'), statsErrors: document.getElementById('stats-errors'), progressBar: document.getElementById('progress-bar'), progressLabel: document.getElementById('progress-label'), settingsBtn: document.getElementById('settings-btn'), settingsModal: document.getElementById('settings-modal'), closeSettingsBtn: document.getElementById('close-settings-btn'), saveSettingsBtn: document.getElementById('save-settings-btn'), modelSelect: document.getElementById('model-select'), delayInput: document.getElementById('delay-input'), translateModal: document.getElementById('translate-modal'), closeTranslateBtn: document.getElementById('close-translate-btn'), translateLanguageList: document.getElementById('translate-language-list'), cleanKeywordsModal: document.getElementById('clean-keywords-modal'), cancelCleanBtn: document.getElementById('cancel-clean-btn'), applyCleanBtn: document.getElementById('apply-clean-btn'), promptStyleSelectModal: document.getElementById('prompt-style-select-modal'), themeToggle: document.getElementById('theme-toggle'), languageSelect: document.getElementById('language-select'), toastContainer: document.getElementById('toast-container'), filterSelect: document.getElementById('filter-select'), sortSelect: document.getElementById('sort-select'), listViewBtn: document.getElementById('list-view-btn'), gridViewBtn: document.getElementById('grid-view-btn'), confirmModal: document.getElementById('confirm-modal'), confirmTitle: document.getElementById('confirm-title'), confirmMessage: document.getElementById('confirm-message'), confirmOkBtn: document.getElementById('confirm-ok-btn'), confirmCancelBtn: document.getElementById('confirm-cancel-btn'), keywordToolsBtn: document.getElementById('keyword-tools-btn'), keywordToolsModal: document.getElementById('keyword-tools-modal'), closeKeywordToolsBtn: document.getElementById('close-keyword-tools-btn'), saveKeywordToolsBtn: document.getElementById('save-keyword-tools-btn'), alwaysIncludeKeywords: document.getElementById('always-include-keywords'), blacklistKeywords: document.getElementById('blacklist-keywords'), savePresetBtn: document.getElementById('save-preset-btn'), presetNameInput: document.getElementById('preset-name-input'), presetSelect: document.getElementById('preset-select'), deletePresetBtn: document.getElementById('delete-preset-btn'), bulkEditPanel: document.getElementById('bulk-edit-panel'), bulkEditBtn: document.getElementById('bulk-edit-btn'),
        };
        
        // --- Custom Confirm Modal ---
        let confirmCallback = null;
        function showConfirm(title, message, callback) {
            dom.confirmTitle.textContent = title;
            dom.confirmMessage.textContent = message;
            confirmCallback = callback;
            dom.confirmModal.classList.remove('hidden');
        }
        dom.confirmOkBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(true);
            dom.confirmModal.classList.add('hidden');
        });
        dom.confirmCancelBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback(false);
            dom.confirmModal.classList.add('hidden');
        });


        const retranslateUI = () => {
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                const content = el.querySelector('span') || el;
                const icon = el.querySelector('i')?.outerHTML || '';
                content.innerHTML = `${icon} ${_(key)}`.trim();
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                el.placeholder = _(el.dataset.langPlaceholder);
            });
        };
        
        // --- Settings, Presets, Keywords Management ---
        const saveSettings = () => {
            settings.model = dom.modelSelect.value;
            settings.delay = parseInt(dom.delayInput.value, 10);
            settings.promptStyle = dom.promptStyleSelectModal.value;
            localStorage.setItem('autoMetaPixSettings', JSON.stringify(settings));
            showToast('‚öôÔ∏è Settings saved successfully!', 'success');
        };
        
        const loadPresets = () => {
             const savedPresets = localStorage.getItem('autoMetaPixPresets');
             if (savedPresets) {
                presets = JSON.parse(savedPresets);
             }
             dom.presetSelect.innerHTML = '<option>Load a preset...</option>';
             for (const presetName in presets) {
                const option = document.createElement('option');
                option.value = presetName;
                option.textContent = presetName;
                dom.presetSelect.appendChild(option);
             }
        }
        
        const loadKeywordSettings = () => {
             const savedKeywords = localStorage.getItem('autoMetaPixKeywordSettings');
             if (savedKeywords) {
                 keywordSettings = JSON.parse(savedKeywords);
                 dom.alwaysIncludeKeywords.value = keywordSettings.alwaysInclude.join(', ');
                 dom.blacklistKeywords.value = keywordSettings.blacklist.join(', ');
             }
        }

        const loadSettings = () => {
            const saved = localStorage.getItem('autoMetaPixSettings');
            if (saved) settings = { ...settings, ...JSON.parse(saved) };
            
            dom.modelSelect.value = settings.model;
            dom.delayInput.value = settings.delay;
            dom.promptStyleSelectModal.value = settings.promptStyle;
            dom.languageSelect.value = settings.language;
            
            if (settings.theme === 'dark') {
                document.documentElement.classList.add('dark');
                dom.themeToggle.innerHTML = '<i class="fas fa-moon text-sm"></i>';
            } else {
                document.documentElement.classList.remove('dark');
                dom.themeToggle.innerHTML = '<i class="fas fa-sun text-sm"></i>';
            }
            loadPresets();
            loadKeywordSettings();
            retranslateUI();
        };
        
        // --- Gallery Filtering and Sorting ---
        function applyFilterAndSort() {
            const cards = Array.from(dom.imageGallery.querySelectorAll('.image-card'));

            cards.sort((a, b) => {
                const objA = imageObjects.get(a.dataset.id);
                const objB = imageObjects.get(b.dataset.id);
                if (!objA || !objB) return 0;

                switch (currentSort) {
                    case 'name_asc': return objA.name.localeCompare(objB.name);
                    case 'name_desc': return objB.name.localeCompare(objA.name);
                    case 'date_asc': return objA.addedTimestamp - objB.addedTimestamp;
                    case 'date_desc': return objB.addedTimestamp - objA.addedTimestamp;
                    default: return 0;
                }
            });

            cards.forEach(card => dom.imageGallery.appendChild(card));

            let visibleCount = 0;
            cards.forEach(card => {
                const obj = imageObjects.get(card.dataset.id);
                const shouldShow = (currentFilter === 'all' || (obj && obj.status === currentFilter));
                card.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            dom.galleryPlaceholder.style.display = (imageObjects.size === 0 || visibleCount === 0) ? 'flex' : 'none';
        }


        // --- UI & Gallery Management ---
        const addFiles = (files) => {
            let addedCount = 0;
            for (const file of files) {
                if (!file.type.startsWith('image/') || imageObjects.has(file.name + '-' + file.lastModified)) continue;
                const reader = new FileReader();
                reader.onload = e => {
                    const imageObject = { file, id: file.name + '-' + file.lastModified, name: file.name, size: file.size, dataURL: e.target.result, metadata: { title: '', description: '', keywords: '' }, status: 'unprocessed', addedTimestamp: Date.now() };
                    imageObjects.set(imageObject.id, imageObject);
                    createImageCard(imageObject);
                    updateStats();
                    applyFilterAndSort();
                };
                reader.readAsDataURL(file);
                addedCount++;
            }
            if(addedCount > 0) showToast(`üìÅ ${addedCount} file(s) added successfully!`, 'success');
        };

        const createImageCard = (imageObject) => {
            const card = dom.imageCardTemplate.content.cloneNode(true).firstElementChild;
            card.dataset.id = imageObject.id;

            card.querySelector('.thumbnail').src = imageObject.dataURL;
            card.querySelector('.filename').textContent = imageObject.name;
            card.querySelector('.file-size').textContent = `${(imageObject.size / 1024 / 1024).toFixed(2)} MB`;
            
            const keywordsInput = card.querySelector('.keywords-input');
            const keywordCount = card.querySelector('.keyword-count');
            const updateKeywordsCount = () => {
                const count = keywordsInput.value.split(',').filter(k => k.trim()).length;
                keywordCount.textContent = `${count} keywords`;
                keywordCount.classList.toggle('!bg-rose-500/20', count > MAX_KEYWORDS);
                keywordCount.classList.toggle('!text-rose-500', count > MAX_KEYWORDS);
            };
            keywordsInput.addEventListener('input', updateKeywordsCount);

            card.querySelectorAll('input, textarea').forEach(input => input.addEventListener('change', e => {
                const key = e.target.classList[0].split('-')[0];
                imageObjects.get(imageObject.id).metadata[key] = e.target.value;
            }));

            card.addEventListener('click', (e) => handleSelection(card, e));
            card.querySelector('.delete-btn').addEventListener('click', e => { 
                e.stopPropagation(); 
                showConfirm('Delete Image?', `Are you sure you want to remove '${imageObject.name}'?`, (confirmed) => {
                    if (confirmed) {
                        imageObjects.delete(imageObject.id); 
                        card.remove(); 
                        updateStats(); 
                        applyFilterAndSort(); 
                        showToast('üóëÔ∏è Image removed', 'info');
                    }
                });
            });
            
            card.querySelector('.generate-btn').addEventListener('click', e => {
                e.stopPropagation();
                if (imageObjects.get(card.dataset.id).status === 'ready') {
                    card.querySelector('.regenerate-menu').classList.toggle('hidden');
                } else {
                    taskQueue.push({ type: 'generate', id: card.dataset.id, options: { title: true, description: true, keywords: true } });
                    totalTasksInBatch = 1; processQueue();
                }
            });
            
            card.querySelectorAll('.regenerate-choice').forEach(choice => choice.addEventListener('click', e => {
                e.preventDefault(); e.stopPropagation();
                const field = e.currentTarget.dataset.field;
                const options = { title: field === 'title' || field === 'all', description: field === 'description' || field === 'all', keywords: field === 'keywords' || field === 'all' };
                taskQueue.push({ type: 'generate', id: card.dataset.id, options });
                totalTasksInBatch = 1; processQueue();
                card.querySelector('.regenerate-menu').classList.add('hidden');
            }));
            
            card.querySelector('.translate-btn').addEventListener('click', e => { e.stopPropagation(); activeModalId = imageObject.id; dom.translateModal.classList.remove('hidden'); });
            card.querySelector('.clean-keywords-btn').addEventListener('click', e => { e.stopPropagation(); activeModalId = imageObject.id; dom.cleanKeywordsModal.classList.remove('hidden'); });
            
            card.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const input = btn.previousElementSibling;
                    input.select();
                    document.execCommand('copy');
                    showToast('üìã Copied to clipboard!', 'success');
                });
            });


            dom.imageGallery.appendChild(card);
            retranslateUI();
        };

        const updateCardStatus = (id, status, metadata = null) => {
            const card = document.querySelector(`.image-card[data-id="${id}"]`);
            if (!card) return;
            const imageObject = imageObjects.get(id);
            if (imageObject) imageObject.status = status;
            const statusLabel = card.querySelector('.status-label');
            const [generateBtn, translateBtn, cleanBtn] = ['.generate-btn', '.translate-btn', '.clean-keywords-btn'].map(s => card.querySelector(s));
            
            card.classList.toggle('processing', status === 'processing');

            statusLabel.className = `status-label text-xs font-bold uppercase tracking-wider py-1.5 px-3 rounded-full shadow-sm status-${status}`;
            statusLabel.textContent = _(`status_${status}`);

            generateBtn.disabled = status === 'processing';
            translateBtn.disabled = status !== 'ready';
            cleanBtn.disabled = status !== 'ready';
            
            const generateBtnSpan = generateBtn.querySelector('span');
            if (status === 'ready') generateBtnSpan.textContent = _('regenerate');
            else generateBtnSpan.textContent = _('generate');

            if (metadata) {
                if (metadata.title !== undefined) imageObject.metadata.title = metadata.title;
                if (metadata.description !== undefined) imageObject.metadata.description = metadata.description;
                if (metadata.keywords !== undefined) imageObject.metadata.keywords = metadata.keywords;
                card.querySelector('.title-input').value = imageObject.metadata.title;
                card.querySelector('.description-input').value = imageObject.metadata.description;
                const kwInput = card.querySelector('.keywords-input');
                kwInput.value = imageObject.metadata.keywords;
                kwInput.dispatchEvent(new Event('input'));
            }
            applyFilterAndSort();
        };

        const handleSelection = (card, event) => {
            const id = card.dataset.id;
            if (!event.ctrlKey && !event.metaKey && !event.shiftKey) {
                selectedCards.forEach(cardId => {
                    document.querySelector(`.image-card[data-id="${cardId}"]`)?.classList.remove('selected');
                });
                selectedCards.clear();
            }

            if (selectedCards.has(id)) {
                selectedCards.delete(id);
                card.classList.remove('selected');
            } else {
                selectedCards.add(id);
                card.classList.add('selected');
            }
            dom.bulkEditPanel.classList.toggle('hidden', selectedCards.size <= 1);
        };
        
        const updateStats = () => {
            let processed = 0, errors = 0;
            imageObjects.forEach(obj => { if (obj.status === 'ready') processed++; if (obj.status === 'error') errors++; });
            dom.statsTotal.textContent = imageObjects.size;
            dom.statsProcessed.textContent = processed;
            dom.statsPending.textContent = imageObjects.size - processed - errors;
            dom.statsErrors.textContent = errors;
        };

        // --- Core Logic ---
        async function processQueue() {
            if (batchStopRequested) {
                taskQueue = [];
                const processingCard = document.querySelector('.status-processing');
                if(processingCard) {
                    const cardDiv = processingCard.closest('.image-card');
                    if(cardDiv) updateCardStatus(cardDiv.dataset.id, 'unprocessed');
                }
                isProcessing = false;
                totalTasksInBatch = 0;
                batchStopRequested = false;
                currentBatchController = null;
                dom.batchAllBtn.classList.remove('hidden');
                dom.stopBatchBtn.classList.add('hidden');
                updateProgress(0, _('ready'));
                showToast('üõë Batch process stopped.', 'info');
                return;
            }

            if (taskQueue.length === 0 || isProcessing) {
                if (taskQueue.length === 0 && totalTasksInBatch > 0) {
                    showToast('üéâ Batch process completed successfully!', 'success');
                    totalTasksInBatch = 0;
                    currentBatchController = null;
                    dom.batchAllBtn.classList.remove('hidden');
                    dom.stopBatchBtn.classList.add('hidden');
                }
                return;
            }

            isProcessing = true;
            const task = taskQueue.shift();
            const imageObject = imageObjects.get(task.id);

            if (!imageObject) { isProcessing = false; processQueue(); return; }
            
            const processedCount = totalTasksInBatch - taskQueue.length - 1;
            const progressPercentage = totalTasksInBatch > 0 ? (processedCount / totalTasksInBatch) * 100 : 0;
            updateProgress(progressPercentage, `Processing: ${imageObject.name}`);
            updateCardStatus(task.id, 'processing');
            updateStats();
            
            if (API_KEYS.length === 0) { showToast('‚ùå No API keys available.', 'error'); updateCardStatus(task.id, 'error'); updateStats(); isProcessing = false; taskQueue = []; return; }

            const executeApiCall = async (retryCount = 0) => {
                const apiKey = API_KEYS[apiKeyIndex++ % API_KEYS.length];
                try {
                    let prompt, payload;
                     if (task.type === 'generate') {
                        prompt = getGenerationPrompt(task.options);
                        const base64Image = imageObject.dataURL.split(',')[1];
                        payload = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: imageObject.file.type, data: base64Image } }] }], generationConfig: { response_mime_type: "application/json" } };
                    } else if (task.type === 'translate') {
                        prompt = getTranslationPrompt(imageObject.metadata, task.language);
                        payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { response_mime_type: "application/json" } };
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${settings.model}:generateContent?key=${apiKey}`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload),
                        signal: currentBatchController ? currentBatchController.signal : null
                    });
                    if (!response.ok) { 
                        const errorText = await response.text();
                        try {
                           const errorData = JSON.parse(errorText);
                           throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                        } catch(e) {
                           throw new Error(errorText || `HTTP error! status: ${response.status}`);
                        }
                    }
                    
                    const result = await response.json();
                    if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0].text) {
                        throw new Error("Invalid response structure from API.");
                    }
                    const textContent = result.candidates[0].content.parts[0].text;
                    let metadata = JSON.parse(textContent);
                    
                    // Post-process keywords
                    let kws = Array.isArray(metadata.keywords) ? metadata.keywords : [];
                    kws = kws.filter(kw => !keywordSettings.blacklist.includes(kw.toLowerCase()));
                    kws = [...new Set([...kws, ...keywordSettings.alwaysInclude])];
                    metadata.keywords = kws.slice(0, MAX_KEYWORDS).join(', ');
                    
                    updateCardStatus(task.id, 'ready', metadata);
                    if (task.type === 'translate') showToast(`üåê Translation to ${task.language} successful!`, 'success');
                    else showToast(`‚ú® Metadata generated for ${imageObject.name}`, 'success');
                    return true; // Success
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('Fetch aborted by user.');
                        updateCardStatus(task.id, 'unprocessed');
                        return false;
                    }

                    console.error(`Attempt ${retryCount + 1} failed for ${imageObject.name}:`, error);
                     if (retryCount < 2) { // Max 3 retries (0, 1, 2)
                        const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
                        showToast(`API call failed, retrying in ${delay / 1000}s...`, 'info');
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return executeApiCall(retryCount + 1);
                    } else {
                        showToast(`‚ùå Failed to process ${imageObject.name}: ${error.message}`, 'error');
                        updateCardStatus(task.id, 'error');
                        return false; // Failure
                    }
                }
            };

            await executeApiCall();

            updateStats();
            isProcessing = false;
            
            if (taskQueue.length > 0) {
                 setTimeout(processQueue, settings.delay * 1000);
            } else if (totalTasksInBatch > 0) {
                // Last item was processed, call again to trigger completion logic
                setTimeout(processQueue, 100); 
            }
        }
        
        function getGenerationPrompt(options) {
            const fields = [];
            if (options.title) fields.push("a title");
            if (options.description) fields.push("a description");
            if (options.keywords) fields.push("keywords");
            const fieldsStr = fields.join(', ').replace(/, ([^,]*)$/, ' and $1');
            const base = {
                microstock: `As a **Microstock Metadata Specialist**, create ${fieldsStr} for the image, optimized for platforms like Adobe Stock. **KEYWORDS:** Generate exactly 49 English keywords, comma-separated, ordered by importance.`,
                professional: `As a **Corporate Metadata Analyst**, create ${fieldsStr} for the image for a B2B audience. **KEYWORDS:** Generate exactly 49 business-focused English keywords, comma-separated.`,
                creative: `As a **Creative Image Curator**, create ${fieldsStr} for the image that capture its mood and story. **KEYWORDS:** Generate exactly 49 conceptual and emotive English keywords, comma-separated.`,
                fotografer: `As a **Professional Photographer**, create ${fieldsStr} for the image from a technical and artistic viewpoint. **KEYWORDS:** Generate exactly 49 photography-focused English keywords, comma-separated.`
            };
            
            let extraInstructions = '';
            if (keywordSettings.alwaysInclude.length > 0) {
                extraInstructions += `\n- ALWAYS INCLUDE these keywords: ${keywordSettings.alwaysInclude.join(', ')}.`;
            }
            if (keywordSettings.blacklist.length > 0) {
                extraInstructions += `\n- DO NOT use these keywords: ${keywordSettings.blacklist.join(', ')}.`;
            }

            let jsonFormat = "{";
            if (options.title) jsonFormat += '"title": "Generated English title here"';
            if (options.description) jsonFormat += (fields.includes("a title") ? ', ' : '') + '"description": "Generated English description here"';
            if (options.keywords) jsonFormat += (fields.includes("a title") || fields.includes("a description") ? ', ' : '') + '"keywords": ["keyword1", "keyword2", ...]';
            jsonFormat += "}";
            return `${base[settings.promptStyle]} ${extraInstructions}\n\nIMPORTANT: Respond ONLY with a valid JSON format like this:\n${jsonFormat}`;
        }
        
        function getTranslationPrompt(metadata, targetLanguage) {
            const data = { ...metadata, keywords: metadata.keywords.split(',').map(k => k.trim()) };
            return `Translate the values in the following JSON to ${targetLanguage}. Keep the keys the same. Respond only with the translated JSON object.\n\n${JSON.stringify(data, null, 2)}`;
        }

        const updateProgress = (percentage, label) => { dom.progressBar.style.width = `${Math.min(100, percentage)}%`; dom.progressLabel.textContent = label; };

        // --- UI Helpers ---
        const showToast = (message, type = 'info') => {
            const colors = { success: 'from-green-400 to-teal-500', error: 'from-rose-400 to-red-500', info: 'from-sky-400 to-cyan-500', warning: 'from-amber-400 to-orange-500' };
            const icon = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle', warning: 'fa-exclamation-triangle' };
            const toast = document.createElement('div');
            toast.className = `bg-gradient-to-r ${colors[type]} text-white py-3 px-5 rounded-xl shadow-2xl flex items-center transform transition-all duration-300 translate-x-full opacity-0`;
            toast.innerHTML = `<i class="fas ${icon[type]} mr-3 text-lg"></i><p class="font-semibold text-sm">${message}</p>`;
            dom.toastContainer.appendChild(toast);
            requestAnimationFrame(() => { toast.style.transform = 'translateX(0)'; toast.style.opacity = '1'; });
            setTimeout(() => { toast.style.transform = 'translateX(120%)'; toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        };

        // --- Event Listeners ---
        dom.addFilesBtn.addEventListener('click', () => dom.fileInput.click());
        dom.addFolderBtn.addEventListener('click', () => dom.folderInput.click());
        dom.fileInput.addEventListener('change', e => { addFiles(e.target.files); e.target.value = null; });
        dom.folderInput.addEventListener('change', e => { addFiles(e.target.files); e.target.value = null; });
        dom.clearAllBtn.addEventListener('click', () => { 
            showConfirm('Clear All Images?', 'This will remove all images from the gallery. This action cannot be undone.', (confirmed) => {
                if(confirmed) {
                    dom.imageGallery.innerHTML = ''; 
                    imageObjects.clear(); 
                    updateStats(); 
                    applyFilterAndSort(); 
                    showToast('üóëÔ∏è All images cleared', 'info');
                }
            });
        });
        
        dom.batchAllBtn.addEventListener('click', () => {
            batchStopRequested = false;
            currentBatchController = new AbortController();
            const orderedCards = Array.from(dom.imageGallery.querySelectorAll('.image-card'));
            const items = orderedCards
                .map(card => imageObjects.get(card.dataset.id))
                .filter(obj => obj && obj.status === 'unprocessed')
                .map(obj => ({ type: 'generate', id: obj.id, options: { title: true, description: true, keywords: true } }));

            if (items.length === 0) {
                showToast('‚ÑπÔ∏è No pending files to process.', 'info');
                return;
            }

            dom.batchAllBtn.classList.add('hidden');
            dom.stopBatchBtn.classList.remove('hidden');

            taskQueue.push(...items);
            totalTasksInBatch = items.length;
            processQueue();
            showToast(`üöÄ Starting batch process for ${items.length} files...`, 'info');
        });

        dom.stopBatchBtn.addEventListener('click', () => {
            batchStopRequested = true;
            if (currentBatchController) {
                currentBatchController.abort();
            }
            showToast('üõë Stopping batch process...', 'warning');
        });

        dom.exportCsvBtn.addEventListener('click', () => {
            const toExport = selectedCards.size > 0 ? 
                Array.from(selectedCards).map(id => imageObjects.get(id)) :
                Array.from(imageObjects.values());
            
            if (toExport.length === 0) { showToast('‚ÑπÔ∏è No files to export.', 'info'); return; }
            let csv = "Filename,Title,Description,Keywords\n";
            toExport.forEach(obj => { csv += `"${obj.name}","${obj.metadata.title.replace(/"/g, '""')}","${obj.metadata.description.replace(/"/g, '""')}","${obj.metadata.keywords.replace(/"/g, '""')}"\n`; });
            const link = document.createElement("a"); link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); link.download = 'metadata_export.csv'; link.click();
            showToast(`üìÅ Exported ${toExport.length} files to CSV`, 'success');
        });

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dom.app.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
        });
        dom.app.addEventListener('drop', e => addFiles(e.dataTransfer.files));

        // Modals & Controls
        dom.settingsBtn.addEventListener('click', () => dom.settingsModal.classList.remove('hidden'));
        dom.closeSettingsBtn.addEventListener('click', () => dom.settingsModal.classList.add('hidden'));
        dom.saveSettingsBtn.addEventListener('click', () => { saveSettings(); dom.settingsModal.classList.add('hidden'); });
        dom.closeTranslateBtn.addEventListener('click', () => dom.translateModal.classList.add('hidden'));
        dom.cancelCleanBtn.addEventListener('click', () => dom.cleanKeywordsModal.classList.add('hidden'));
        dom.applyCleanBtn.addEventListener('click', () => {
            if (!activeModalId) return;
            const keywordsInput = document.querySelector(`.image-card[data-id="${activeModalId}"] .keywords-input`);
            let keywords = keywordsInput.value.split(',').map(k => k.trim()).filter(Boolean);
            if(document.getElementById('clean-lowercase').checked) keywords = keywords.map(k => k.toLowerCase());
            if(document.getElementById('clean-duplicates').checked) keywords = [...new Set(keywords)];
            keywordsInput.value = keywords.join(', ');
            keywordsInput.dispatchEvent(new Event('input'));
            imageObjects.get(activeModalId).metadata.keywords = keywordsInput.value;
            dom.cleanKeywordsModal.classList.add('hidden');
            showToast('üßπ Keywords cleaned successfully!', 'success');
        });
        document.addEventListener('click', e => { if (!e.target.closest('.generate-btn')) document.querySelectorAll('.regenerate-menu').forEach(m => m.classList.add('hidden')); });
        
        dom.themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            settings.theme = isDark ? 'dark' : 'light';
            dom.themeToggle.innerHTML = isDark ? '<i class="fas fa-moon text-sm"></i>' : '<i class="fas fa-sun text-sm"></i>';
            localStorage.setItem('autoMetaPixSettings', JSON.stringify(settings));
        });
        
        dom.languageSelect.addEventListener('change', e => {
            settings.language = e.target.value;
            localStorage.setItem('autoMetaPixSettings', JSON.stringify(settings));
            retranslateUI();
        });
        
        dom.filterSelect.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            applyFilterAndSort();
        });

        dom.sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            applyFilterAndSort();
        });

        const setView = (view) => {
            if (view === 'grid') {
                dom.imageGallery.classList.remove('list-view');
                dom.imageGallery.classList.add('grid-view');
                dom.gridViewBtn.classList.add('active');
                dom.listViewBtn.classList.remove('active');
            } else {
                dom.imageGallery.classList.remove('grid-view');
                dom.imageGallery.classList.add('list-view');
                dom.listViewBtn.classList.add('active');
                dom.gridViewBtn.classList.remove('active');
            }
        };

        dom.listViewBtn.addEventListener('click', () => setView('list'));
        dom.gridViewBtn.addEventListener('click', () => setView('grid'));
        
        // Keyword Tools Modal
        dom.keywordToolsBtn.addEventListener('click', () => dom.keywordToolsModal.classList.remove('hidden'));
        dom.closeKeywordToolsBtn.addEventListener('click', () => dom.keywordToolsModal.classList.add('hidden'));
        dom.saveKeywordToolsBtn.addEventListener('click', () => {
            keywordSettings.alwaysInclude = dom.alwaysIncludeKeywords.value.split(',').map(k => k.trim().toLowerCase()).filter(Boolean);
            keywordSettings.blacklist = dom.blacklistKeywords.value.split(',').map(k => k.trim().toLowerCase()).filter(Boolean);
            localStorage.setItem('autoMetaPixKeywordSettings', JSON.stringify(keywordSettings));
            showToast('üîë Keyword rules saved!', 'success');
            dom.keywordToolsModal.classList.add('hidden');
        });
        
        // Presets
        dom.savePresetBtn.addEventListener('click', () => {
            const name = dom.presetNameInput.value.trim();
            if (name) {
                presets[name] = { ...settings };
                localStorage.setItem('autoMetaPixPresets', JSON.stringify(presets));
                loadPresets();
                dom.presetNameInput.value = '';
                showToast(`üíæ Preset '${name}' saved!`, 'success');
            }
        });
        
        dom.presetSelect.addEventListener('change', (e) => {
            const presetName = e.target.value;
            if (presets[presetName]) {
                settings = { ...presets[presetName] };
                loadSettings(); // Reload all settings into UI
                showToast(`üîÑ Preset '${presetName}' loaded!`, 'info');
            }
        });

        dom.deletePresetBtn.addEventListener('click', () => {
            const presetName = dom.presetSelect.value;
            if (presets[presetName]) {
                 showConfirm('Delete Preset?', `Are you sure you want to delete the '${presetName}' preset?`, (confirmed) => {
                    if (confirmed) {
                        delete presets[presetName];
                        localStorage.setItem('autoMetaPixPresets', JSON.stringify(presets));
                        loadPresets();
                        showToast(`üóëÔ∏è Preset '${presetName}' deleted!`, 'info');
                    }
                 });
            }
        });


        // --- Initialization ---
        const initialize = () => {
            TARGET_LANGUAGES.forEach(lang => {
                const btn = document.createElement('button');
                btn.className = 'w-full text-left p-3 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition font-semibold flex items-center space-x-3';
                const flags = { English: 'üá∫üá∏', Indonesian: 'üáÆüá©', Spanish: 'üá™üá∏', French: 'üá´üá∑', German: 'üá©üá™', Japanese: 'üáØüáµ', Korean: 'üá∞üá∑' };
                btn.innerHTML = `<span class="text-2xl">${flags[lang] || 'üåê'}</span><span>${lang}</span>`;
                btn.addEventListener('click', () => {
                    if (activeModalId) {
                        taskQueue.push({ type: 'translate', id: activeModalId, language: lang });
                        totalTasksInBatch = 1; processQueue();
                    }
                    dom.translateModal.classList.add('hidden');
                });
                dom.translateLanguageList.appendChild(btn);
            });
            loadSettings();
            showToast('üéâ Welcome to Indexinode Pro!', 'info');
        };

        initialize();
    });
    </script>
</body>

</html>


